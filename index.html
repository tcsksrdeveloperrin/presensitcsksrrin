<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presensi Mobile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="max-w-md mx-auto bg-white min-h-screen shadow-lg flex flex-col">
        <div class="p-6 bg-blue-600 text-white rounded-b-3xl shadow-lg flex justify-between items-start">
            <div>
                <h2 id="userName" class="text-xl font-bold">Memuat...</h2>
                <p id="branchName" class="text-sm opacity-80 italic">Mendeteksi cabang...</p>
            </div>
            <button onclick="logout()" class="text-xs bg-red-500 px-3 py-1 rounded-lg font-bold">Logout</button>
        </div>

        <div class="p-4 flex-1">
            <div class="relative rounded-3xl overflow-hidden bg-black aspect-[3/4] shadow-2xl border-4 border-white">
                <video id="video" autoplay playsinline class="w-full h-full object-cover"></video>
                <canvas id="canvas" class="hidden"></canvas>
                <div class="absolute bottom-4 left-4 bg-black/40 backdrop-blur-md text-white p-3 text-[10px] rounded-xl border border-white/20">
                    <p id="current-time">WIB: --:--</p>
                    <p id="coordsWatermark">GPS: Tracking...</p>
                </div>
            </div>

            <div class="mt-6 space-y-4">
                <select id="attendanceType" class="w-full p-4 rounded-2xl border-2 border-gray-100 font-bold text-gray-700 focus:border-blue-500 outline-none">
                    <option value="Masuk">Masuk Kerja</option>
                    <option value="Pulang">Pulang Kerja</option>
                </select>

                <p id="locationStatus" class="text-center text-sm font-semibold text-orange-500 animate-pulse">
                    Mengecek GPS...
                </p>

                <button id="btnAbsen" disabled onclick="takePhoto()"
                    class="w-full py-4 bg-gray-400 text-white rounded-2xl font-bold shadow-lg transition-all active:scale-95">
                    Ambil Foto & Kirim
                </button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://ubcjzcczplfakodxgajg.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InViY2p6Y2N6cGxmYWtvZHhnYWpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxODMwNDYsImV4cCI6MjA4NTc1OTA0Nn0.knzmrpJOqbZkduGIvZVK4zApoZiSXqCdhMVzcgkMaBE";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let stream;
        let userCoords = null;

        // Inisialisasi Kamera & Data User
        async function init() {
            try {
                // Kamera
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                document.getElementById('video').srcObject = stream;

                // Cek Login & Nama
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) window.location.href = 'login.html';

                const { data: profile } = await supabaseClient.from('profiles').select('full_name').eq('id', user.id).single();
                document.getElementById('userName').innerText = profile ? profile.full_name : "User";

                // Tracking GPS
                navigator.geolocation.watchPosition(pos => {
                    userCoords = pos.coords;
                    document.getElementById('coordsWatermark').innerText = `GPS: ${pos.coords.latitude.toFixed(4)}, ${pos.coords.longitude.toFixed(4)}`;
                    document.getElementById('locationStatus').innerText = "Lokasi Siap (Siap Absen)";
                    document.getElementById('locationStatus').className = "text-center text-sm font-semibold text-green-500";
                    document.getElementById('btnAbsen').disabled = false;
                    document.getElementById('btnAbsen').className = "w-full py-4 bg-blue-600 text-white rounded-2xl font-bold shadow-lg";
                });

                // Update Jam
                setInterval(() => {
                    document.getElementById('current-time').innerText = "WIB: " + new Date().toLocaleTimeString('id-ID');
                }, 1000);

            } catch (err) {
                alert("Izin kamera/lokasi ditolak!");
            }
        }

        async function takePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);
            
            const photoBlob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.7));
            uploadAttendance(photoBlob);
        }

        async function uploadAttendance(blob) {
            const btn = document.getElementById('btnAbsen');
            btn.innerText = "Mengirim...";
            btn.disabled = true;

            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                const fileName = `absensi_${user.id}_${Date.now()}.jpg`;

                // 1. Upload Foto ke Storage
                const { data: uploadData, error: uploadError } = await supabaseClient.storage
                    .from('attendance-photos')
                    .upload(fileName, blob);

                if (uploadError) throw uploadError;

                const photoUrl = `${SUPABASE_URL}/storage/v1/object/public/attendance-photos/${fileName}`;

                // 2. Simpan Data ke Tabel Attendance
                const { error: dbError } = await supabaseClient.from('attendance').insert([{
                    user_id: user.id,
                    photo_url: photoUrl,
                    notes: document.getElementById('attendanceType').value,
                    latitude: userCoords.latitude,
                    longitude: userCoords.longitude,
                    distance_meters: 0 // Logika jarak bisa ditambahkan di sini
                }]);

                if (dbError) throw dbError;

                alert("Absensi Berhasil!");
                location.reload();

            } catch (err) {
                alert("Gagal: " + err.message);
                btn.innerText = "Ambil Foto & Kirim";
                btn.disabled = false;
            }
        }

        async function logout() {
            await supabaseClient.auth.signOut();
            window.location.href = 'login.html';
        }

        init();
    </script>
</body>
</html>
