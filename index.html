<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presensi Mobile - TC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        /* Fix Kamera Zoom & No Mirror */
        #video-container {
            position: relative;
            width: 100%;
            padding-top: 133%; /* Aspect Ratio 4:3 */
            background: #000;
            border-radius: 2rem;
            overflow: hidden;
            margin-top: -60px; /* Menumpuk di atas header melengkung */
            z-index: 10;
        }
        #video, #capturedImage {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: none; /* No Mirroring */
        }
        #capturedImage {
            display: none;
        }
        /* Desain Header Melengkung */
        .header-curve {
            background-color: #2563eb; /* Royal Blue */
            height: 160px;
            border-bottom-left-radius: 50px;
            border-bottom-right-radius: 50px;
            padding: 20px;
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2563eb;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">

    <div class="header-curve text-white relative shadow-lg">
        <div class="flex items-center gap-3">
            <button onclick="window.history.back()" class="p-2 hover:bg-blue-500 rounded-full transition-colors">
                <i class="ri-arrow-left-line text-2xl"></i>
            </button>
            <h1 class="text-xl font-bold">Rekam Kehadiran</h1>
        </div>
    </div>

    <div class="max-w-md mx-auto px-5 pb-32">
        
        <div id="cameraSection">
            <div id="video-container" class="shadow-2xl border-[6px] border-white">
                <video id="video" autoplay playsinline></video>
                <img id="capturedImage" src="" alt="Hasil Foto">
                <canvas id="canvas" class="hidden"></canvas>
            </div>

            <div class="text-center mt-6 mb-6" id="instructionText">
                <h2 class="font-bold text-gray-800 text-lg">Ambil Foto Selfie</h2>
                <p class="text-sm text-gray-500">Pastikan wajah terlihat jelas di area kantor.</p>
            </div>

            <div class="space-y-4" id="formSection">
                <select id="attendanceType" class="w-full p-4 rounded-2xl border-none shadow-md font-bold text-gray-700 bg-white focus:ring-2 focus:ring-blue-500">
                    <option value="Masuk">Masuk Kerja</option>
                    <option value="Pulang">Pulang Kerja</option>
                </select>

                <div id="locationStatus" class="flex items-center justify-center gap-2 text-sm font-bold text-blue-600 bg-blue-50 p-3 rounded-2xl border border-blue-100">
                    <div class="loader"></div> Mencari Lokasi...
                </div>
            </div>
        </div>

        <div id="previewSection" class="hidden mt-8">
            <div class="bg-white rounded-3xl border border-gray-100 shadow-xl p-6 mb-6">
                <div class="text-center border-b border-gray-100 pb-4 mb-4">
                    <h2 id="prevName" class="text-2xl font-black text-gray-900 uppercase">Memuat...</h2>
                    <p id="prevRole" class="text-blue-500 font-medium tracking-wide">Role...</p>
                </div>

                <div class="space-y-4 text-sm">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400 font-medium">Shift</span>
                        <span class="font-bold text-gray-800 bg-gray-50 px-3 py-1 rounded-lg" id="prevShift">Reguler</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400 font-medium">Area</span>
                        <span class="font-bold text-gray-800" id="prevArea">-</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400 font-medium">Tanggal</span>
                        <span class="font-bold text-gray-800" id="prevDate">-</span>
                    </div>
                </div>

                <div class="mt-6 pt-4 border-t border-gray-100">
                    <p class="text-xs font-bold text-gray-400 uppercase mb-3 tracking-widest">Lokasi Absensi</p>
                    <div class="bg-blue-50 rounded-2xl p-4 flex gap-4 items-start">
                        <div class="bg-blue-600 text-white rounded-xl p-2 shadow-lg shadow-blue-200">
                            <i class="ri-map-pin-2-fill text-xl"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-[13px] font-bold text-gray-800 leading-snug mb-1" id="addressText">Mengambil alamat...</p>
                            <p class="text-[10px] text-blue-400 font-mono" id="coordsText">Lat, Long</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 p-6 bg-white/80 backdrop-blur-lg border-t border-gray-100 max-w-md mx-auto z-50">
        <button id="btnCapture" onclick="capturePhoto()" disabled 
            class="w-full py-4 bg-gray-300 text-white rounded-2xl font-black text-lg shadow-xl shadow-gray-200 transition-all uppercase tracking-wider">
            Ambil Foto
        </button>

        <div id="actionButtons" class="hidden flex gap-4">
            <button onclick="resetCamera()" class="flex-1 py-4 border-2 border-blue-600 text-blue-600 rounded-2xl font-bold hover:bg-blue-50 transition-colors">
                Ulangi
            </button>
            <button id="btnSubmit" onclick="uploadAttendance()" class="flex-[2] py-4 bg-blue-600 text-white rounded-2xl font-black shadow-xl shadow-blue-200 hover:bg-blue-700 transition-all uppercase tracking-wider">
                Simpan Kehadiran
            </button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://ubcjzcczplfakodxgajg.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InViY2p6Y2N6cGxmYWtvZHhnYWpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxODMwNDYsImV4cCI6MjA4NTc1OTA0Nn0.knzmrpJOqbZkduGIvZVK4zApoZiSXqCdhMVzcgkMaBE";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let stream, userCoords, currentProfile;
        let photoBlob = null;

        async function init() {
            try {
                const videoEl = document.getElementById('video');
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user", width: { ideal: 640 }, height: { ideal: 480 } } 
                });
                videoEl.srcObject = stream;

                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return window.location.href = 'login.html';

                const { data: profile } = await supabaseClient
                    .from('profiles')
                    .select('*, branches(name, radius_meter, lat, lng)')
                    .eq('id', user.id)
                    .single();

                if (profile) {
                    currentProfile = profile;
                    document.getElementById('prevName').innerText = profile.full_name;
                    document.getElementById('prevRole').innerText = profile.role || "Staff";
                    document.getElementById('prevArea').innerText = profile.branches?.name || "Pusat";
                    
                    const now = new Date();
                    const options = { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute:'2-digit' };
                    document.getElementById('prevDate').innerText = now.toLocaleDateString('id-ID', options);
                }

                navigator.geolocation.watchPosition(
                    successLocation, 
                    errorLocation, 
                    { enableHighAccuracy: true, maximumAge: 10000 }
                );

            } catch (err) {
                alert("Error Init: " + err.message);
            }
        }

        function successLocation(pos) {
            userCoords = pos.coords;
            const btn = document.getElementById('btnCapture');
            const status = document.getElementById('locationStatus');
            
            status.innerHTML = `<i class="ri-checkbox-circle-fill text-green-500 text-lg"></i> <span class="text-green-600">Lokasi Sesuai (Siap Absen)</span>`;
            status.className = "flex items-center justify-center gap-2 text-sm font-bold text-green-600 bg-green-50 p-3 rounded-2xl border border-green-100 shadow-sm";
            
            document.getElementById('coordsText').innerText = `Lat: ${pos.coords.latitude.toFixed(6)}, Long: ${pos.coords.longitude.toFixed(6)}`;
            
            btn.disabled = false;
            btn.classList.remove('bg-gray-300');
            btn.classList.add('bg-blue-600', 'shadow-blue-200');
        }

        function errorLocation(err) {
            document.getElementById('locationStatus').innerText = "Gagal GPS: " + err.message;
        }

        async function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const imgPreview = document.getElementById('capturedImage');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            photoBlob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.8));
            
            imgPreview.src = URL.createObjectURL(photoBlob);
            imgPreview.style.display = 'block';
            video.style.display = 'none';

            document.getElementById('formSection').classList.add('hidden');
            document.getElementById('instructionText').classList.add('hidden');
            document.getElementById('previewSection').classList.remove('hidden');
            document.getElementById('btnCapture').classList.add('hidden');
            document.getElementById('actionButtons').classList.remove('hidden');

            fetchAddress(userCoords.latitude, userCoords.longitude);
        }

        function resetCamera() {
            document.getElementById('capturedImage').style.display = 'none';
            document.getElementById('video').style.display = 'block';
            
            document.getElementById('formSection').classList.remove('hidden');
            document.getElementById('instructionText').classList.remove('hidden');
            document.getElementById('previewSection').classList.add('hidden');
            document.getElementById('btnCapture').classList.remove('hidden');
            document.getElementById('actionButtons').classList.add('hidden');
        }

        async function fetchAddress(lat, lng) {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                const data = await res.json();
                document.getElementById('addressText').innerText = data.display_name || "Alamat tidak ditemukan";
            } catch (e) {
                document.getElementById('addressText').innerText = "Gagal memuat alamat detail";
            }
        }

        async function uploadAttendance() {
            const btn = document.getElementById('btnSubmit');
            btn.innerText = "MENYIMPAN...";
            btn.disabled = true;

            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                const branch = (currentProfile.branches?.name || "Pusat").replace(/\s+/g, '_');
                const name = currentProfile.full_name.replace(/\s+/g, '_');
                const role = currentProfile.role || "Staff";
                const date = new Date().toISOString().replace(/[:.]/g, '-');
                
                const fileName = `uploads/${branch}/${branch}_${name}_${role}_${date}.jpg`;

                const { error: upErr } = await supabaseClient.storage
                    .from('attendance-photos')
                    .upload(fileName, photoBlob);

                if (upErr) throw new Error("Gagal Upload: " + upErr.message);

                const { data: { publicUrl } } = supabaseClient.storage
                    .from('attendance-photos')
                    .getPublicUrl(fileName);

                const distance = calculateDistance(userCoords.latitude, userCoords.longitude, 
                                                currentProfile.branches?.lat, currentProfile.branches?.lng);

                const { error: dbErr } = await supabaseClient.from('attendance').insert([{
                    user_id: user.id,
                    branch_id: currentProfile.branch_id,
                    photo_url: publicUrl,
                    notes: document.getElementById('attendanceType').value,
                    lat: userCoords.latitude,
                    long: userCoords.longitude,
                    distance_meters: distance,
                    status: 'Hadir'
                }]);

                if (dbErr) throw dbErr;

                alert("Berhasil disimpan!");
                window.location.href = "index.html";

            } catch (err) {
                alert("Gagal: " + err.message);
                btn.innerText = "SIMPAN KEHADIRAN";
                btn.disabled = false;
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            if(!lat2 || !lon2) return 0;
            const R = 6371e3;
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ/2) * Math.sin(Δλ/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        init();
    </script>
</body>
</html>
