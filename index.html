<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presensi Mobile - TC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="max-w-md mx-auto bg-white min-h-screen shadow-lg flex flex-col">
        
        <div class="p-6 bg-blue-600 text-white rounded-b-3xl shadow-lg flex justify-between items-start">
            <div>
                <h2 id="userName" class="text-xl font-bold">Memuat...</h2>
                <p id="branchName" class="text-sm opacity-80 italic">Mendeteksi cabang...</p>
            </div>
            <button onclick="logout()" class="text-xs bg-red-500 hover:bg-red-600 px-3 py-1 rounded-lg font-bold transition-colors">
                Logout
            </button>
        </div>

        <div class="p-4 flex-1">
            <div class="relative rounded-3xl overflow-hidden bg-black aspect-[3/4] shadow-2xl border-4 border-white">
                <video id="video" autoplay playsinline class="w-full h-full object-cover"></video>
                <canvas id="canvas" class="hidden"></canvas>
                
                <div class="absolute bottom-4 left-4 bg-black/40 backdrop-blur-md text-white p-3 text-[10px] rounded-xl border border-white/20">
                    <p id="current-time">WIB: --:--</p>
                    <p id="coordsWatermark">GPS: Tracking...</p>
                </div>
            </div>

            <div class="mt-6 space-y-4">
                <select id="attendanceType" class="w-full p-4 rounded-2xl border-2 border-gray-100 font-bold text-gray-700 focus:border-blue-500 outline-none transition-all">
                    <option value="Masuk">Masuk Kerja</option>
                    <option value="Pulang">Pulang Kerja</option>
                </select>

                <p id="locationStatus" class="text-center text-sm font-semibold text-orange-500 animate-pulse">
                    Mengecek GPS...
                </p>

                <button id="btnAbsen" disabled onclick="takePhoto()"
                    class="w-full py-4 bg-gray-400 text-white rounded-2xl font-bold shadow-lg transition-all active:scale-95 flex justify-center items-center gap-2">
                    <span id="btnText">Ambil Foto & Kirim</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://ubcjzcczplfakodxgajg.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InViY2p6Y2N6cGxmYWtvZHhnYWpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxODMwNDYsImV4cCI6MjA4NTc1OTA0Nn0.knzmrpJOqbZkduGIvZVK4zApoZiSXqCdhMVzcgkMaBE";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let stream;
        let userCoords = null;
        let currentProfile = null;

        async function init() {
            try {
                // 1. Akses Kamera
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user", width: { ideal: 720 }, height: { ideal: 1280 } } 
                });
                document.getElementById('video').srcObject = stream;

                // 2. Cek Sesi User
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) {
                    window.location.href = 'login.html';
                    return;
                }

                // 3. Ambil Detail Profil & Cabang
                const { data: profile } = await supabaseClient
                    .from('profiles')
                    .select('full_name, branch_id, branches(name)')
                    .eq('id', user.id)
                    .single();

                if (profile) {
                    currentProfile = profile;
                    document.getElementById('userName').innerText = profile.full_name;
                    document.getElementById('branchName').innerText = profile.branches?.name || "Pusat";
                }

                // 4. Tracking GPS
                navigator.geolocation.watchPosition(
                    (pos) => {
                        userCoords = pos.coords;
                        document.getElementById('coordsWatermark').innerText = `GPS: ${pos.coords.latitude.toFixed(5)}, ${pos.coords.longitude.toFixed(5)}`;
                        document.getElementById('locationStatus').innerText = "Lokasi Siap (Sesuai)";
                        document.getElementById('locationStatus').className = "text-center text-sm font-semibold text-green-500";
                        
                        const btn = document.getElementById('btnAbsen');
                        btn.disabled = false;
                        btn.className = "w-full py-4 bg-blue-600 text-white rounded-2xl font-bold shadow-lg transition-all active:scale-95";
                    },
                    (err) => {
                        document.getElementById('locationStatus').innerText = "GPS Error: " + err.message;
                    },
                    { enableHighAccuracy: true }
                );

                // 5. Jam Realtime
                setInterval(() => {
                    const now = new Date();
                    document.getElementById('current-time').innerText = "WIB: " + now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                }, 1000);

            } catch (err) {
                console.error(err);
                alert("Mohon izinkan akses Kamera dan Lokasi untuk absen.");
            }
        }

        async function takePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);
            
            const photoBlob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.8));
            uploadAttendance(photoBlob);
        }

        async function uploadAttendance(blob) {
            const btn = document.getElementById('btnAbsen');
            const btnText = document.getElementById('btnText');
            
            btnText.innerText = "Mengirim...";
            btn.disabled = true;

            try {
                // Periksa koneksi internet sebelum fetch
                if (!navigator.onLine) throw new Error("Koneksi internet terputus.");

                const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
                if (userError || !user) throw new Error("Sesi berakhir, silakan login ulang.");

                const fileName = `attendance/${user.id}/${Date.now()}.jpg`;

                // A. Upload ke Storage
                const { error: uploadError } = await supabaseClient.storage
                    .from('attendance-photos')
                    .upload(fileName, blob);

                if (uploadError) throw new Error("Gagal upload foto: " + uploadError.message);

                const { data: { publicUrl } } = supabaseClient.storage
                    .from('attendance-photos')
                    .getPublicUrl(fileName);

                // B. Simpan ke Database (Perbaikan kolom: lat & long)
                // Pastikan kolom di Supabase memang 'lat' dan 'long'
                const { error: dbError } = await supabaseClient
                    .from('attendance')
                    .insert([{
                        user_id: user.id,
                        branch_id: currentProfile?.branch_id,
                        photo_url: publicUrl,
                        notes: document.getElementById('attendanceType').value,
                        lat: userCoords.latitude,
                        long: userCoords.longitude,
                        distance_meters: 0
                    }]);

                if (dbError) {
                    // Cek jika error karena kolom tidak ditemukan
                    if (dbError.message.includes("latitude")) {
                         throw new Error("Error Database: Kolom 'latitude' tidak ditemukan. Pastikan kolom bernama 'lat'.");
                    }
                    throw dbError;
                }

                alert("Berhasil! Absen Anda telah tercatat.");
                location.reload();

            } catch (err) {
                // Menangani AbortError atau Failed to Fetch secara lebih ramah
                console.error("Detail Error:", err);
                let msg = err.message;
                if (msg.includes("fetch")) msg = "Gagal menghubungi server. Periksa sinyal internet Anda.";
                
                alert("Gagal: " + msg);
                btnText.innerText = "Ambil Foto & Kirim";
                btn.disabled = false;
            }
        }

        async function logout() {
            await supabaseClient.auth.signOut();
            window.location.href = 'login.html';
        }

        init();
    </script>
</body>
</html>
