<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Dashboard - TC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 text-gray-800">

    <nav class="bg-white border-b px-6 py-4 flex justify-between items-center sticky top-0 z-50">
        <div>
            <h1 class="text-xl font-bold text-gray-800">Manager Dashboard</h1>
            <p id="branchNameDisplay" class="text-xs text-gray-500">Memuat Cabang...</p>
        </div>
        <button onclick="logout()" class="text-red-500 font-bold text-sm">Logout</button>
    </nav>

    <main class="p-6 max-w-6xl mx-auto">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500">
                <p class="text-gray-400 text-xs font-bold uppercase">Total Hadir Hari Ini</p>
                <h2 id="statTotal" class="text-3xl font-bold text-gray-800">0</h2>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500">
                <p class="text-gray-400 text-xs font-bold uppercase">Tepat Waktu</p>
                <h2 id="statOnTime" class="text-3xl font-bold text-green-600">0</h2>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-red-500">
                <p class="text-gray-400 text-xs font-bold uppercase">Terlambat (Late)</p>
                <h2 id="statLate" class="text-3xl font-bold text-red-600">0</h2>
                <p class="text-[10px] text-gray-400">*Berdasarkan jam masuk > 08:00</p>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="p-4 border-b">
                <h3 class="font-bold">Aktivitas Hari Ini</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3">Nama</th>
                            <th class="px-6 py-3">Jam Masuk</th>
                            <th class="px-6 py-3">Status Waktu</th>
                            <th class="px-6 py-3">Foto</th>
                        </tr>
                    </thead>
                    <tbody id="managerTableBody" class="divide-y">
                        </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        const SUPABASE_URL = "https://ubcjzcczplfakodxgajg.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InViY2p6Y2N6cGxmYWtvZHhnYWpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxODMwNDYsImV4cCI6MjA4NTc1OTA0Nn0.knzmrpJOqbZkduGIvZVK4zApoZiSXqCdhMVzcgkMaBE";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function init() {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) return window.location.href = 'login.html';

            // Ambil Branch Manager
            const { data: profile } = await supabaseClient
                .from('profiles')
                .select('branch_id, branches(name)')
                .eq('id', user.id)
                .single();

            document.getElementById('branchNameDisplay').innerText = `Cabang: ${profile.branches?.name}`;

            // Ambil Data Absen Hari Ini (Filter tanggal)
            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
            
            const { data: attendance } = await supabaseClient
                .from('attendance')
                .select('created_at, photo_url, profiles(full_name)')
                .eq('branch_id', profile.branch_id)
                .gte('created_at', today + 'T00:00:00')
                .lte('created_at', today + 'T23:59:59')
                .order('created_at', { ascending: false });

            calculateStats(attendance);
            renderTable(attendance);
        }

        function calculateStats(data) {
            let total = data.length;
            let late = 0;
            
            // Logika Telat Sederhana (Contoh: Jam Masuk > 08:00 Pagi)
            // Anda bisa mengubah logic ini sesuai jam shift
            data.forEach(row => {
                const hour = new Date(row.created_at).getHours();
                const minute = new Date(row.created_at).getMinutes();
                if (hour > 8 || (hour === 8 && minute > 15)) { // Telat jika lewat 08:15
                    late++;
                }
            });

            document.getElementById('statTotal').innerText = total;
            document.getElementById('statLate').innerText = late;
            document.getElementById('statOnTime').innerText = total - late;
        }

        function renderTable(data) {
            const tbody = document.getElementById('managerTableBody');
            tbody.innerHTML = '';
            
            if(data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-gray-400">Belum ada absen hari ini.</td></tr>';
                return;
            }

            data.forEach(row => {
                const dateObj = new Date(row.created_at);
                const time = dateObj.toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'});
                const hour = dateObj.getHours();
                
                // Badge Status
                let statusBadge = '<span class="text-green-600 bg-green-100 px-2 py-1 rounded text-xs font-bold">Tepat Waktu</span>';
                if (hour > 8) statusBadge = '<span class="text-red-600 bg-red-100 px-2 py-1 rounded text-xs font-bold">Telat</span>';

                tbody.innerHTML += `
                    <tr>
                        <td class="px-6 py-4 font-bold">${row.profiles?.full_name}</td>
                        <td class="px-6 py-4">${time} WIB</td>
                        <td class="px-6 py-4">${statusBadge}</td>
                        <td class="px-6 py-4"><a href="${row.photo_url}" target="_blank" class="text-blue-500 text-xs font-bold">Lihat</a></td>
                    </tr>
                `;
            });
        }

        async function logout() {
            await supabaseClient.auth.signOut();
            window.location.href = 'login.html';
        }

        init();
    </script>
</body>
</html>
