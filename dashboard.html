<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // --- 1. CONFIGURATION ---
    const SUPABASE_URL = "https://ubcjzcczplfakodxgajg.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InViY2p6Y2N6cGxmYWtvZHhnYWpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxODMwNDYsImV4cCI6MjA4NTc1OTA0Nn0.knzmrpJOqbZkduGIvZVK4zApoZiSXqCdhMVzcgkMaBE";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- 2. LOGIC DASHBOARD ---
    async function loadDashboard() {
        const tableBody = document.getElementById('attendanceList');
        const totalCountEl = document.getElementById('totalPresence');
    
        // Pastikan elemen ada sebelum menjalankan script untuk cegah blank page
        if (!tableBody || !totalCountEl) return;
    
        // A. Rentang Waktu Hari Ini
        const start = new Date();
        start.setHours(0, 0, 0, 0);
        const end = new Date();
        end.setHours(23, 59, 59, 999);
    
        try {
            // B. Ambil Data dengan Kolom yang Benar (check_in & notes)
            const { data: attendanceData, error } = await supabaseClient
                .from('attendance')
                .select(`
                    *,
                    profiles:user_id (full_name)
                `)
                .gte('check_in', start.toISOString()) 
                .lte('check_in', end.toISOString())
                .order('check_in', { ascending: false });
    
            if (error) throw error;
    
            // C. Update Angka Total
            totalCountEl.innerText = attendanceData.length;
    
            // D. Render Tabel
            tableBody.innerHTML = ''; 
            
            if (attendanceData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Belum ada presensi hari ini.</td></tr>';
            } else {
                attendanceData.forEach(item => {
                    // Gunakan kolom 'check_in'
                    const time = new Date(item.check_in).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                    const name = item.profiles ? item.profiles.full_name : 'Unknown';
                    
                    // Gunakan kolom 'notes' sebagai pengganti 'type'
                    const attendanceNote = item.notes || 'Hadir'; 
                    const badgeColor = attendanceNote.toLowerCase().includes('pulang') ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800';
    
                    tableBody.innerHTML += `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-3 px-4 text-sm font-medium text-gray-900">${name}</td>
                            <td class="py-3 px-4 text-sm text-gray-500">${time}</td>
                            <td class="py-3 px-4 text-sm">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${badgeColor}">
                                    ${attendanceNote}
                                </span>
                            </td>
                            <td class="py-3 px-4 text-sm text-blue-600 cursor-pointer" onclick="window.open('${item.photo_url}', '_blank')">
                                Lihat Foto
                            </td>
                        </tr>
                    `;
                });
            }
        } catch (err) {
            console.error("Dashboard Error:", err);
            tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-500">Error: ${err.message}</td></tr>`;
        }
    }
    // --- 3. LOGOUT ---
    function logout() {
        supabaseClient.auth.signOut().then(() => window.location.href = 'login.html');
    }

    // --- 4. INIT ---
    async function checkManager() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) {
            window.location.href = 'login.html';
            return;
        }
        loadDashboard();
        
        // Auto-refresh data setiap 30 detik agar dashboard update otomatis
        setInterval(loadDashboard, 30000);
    }
    
    checkManager();
</script>


